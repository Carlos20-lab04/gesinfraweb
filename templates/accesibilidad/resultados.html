{% extends 'base.html' %}

{% block content %}
<div class="container mt-4 mb-5">
    <h2 class="text-center mb-4"><i class="bi bi-bar-chart-line-fill"></i> Informe de Accesibilidad</h2>

    <div class="row mb-5">
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-white fw-bold text-center">Tecnología: Facilidad de Interfaz</div>
                <div class="card-body">
                    <canvas id="chartInterfaz"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-white fw-bold text-center">Infraestructura: Elementos de Apoyo</div>
                <div class="card-body">
                    <canvas id="chartApoyo"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-white fw-bold text-center">Pedagogía: Barreras Frecuentes</div>
                <div class="card-body">
                    <canvas id="chartBarreras"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-white fw-bold text-center">Gestión: Políticas Claras</div>
                <div class="card-body">
                    <canvas id="chartPoliticas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Registro Detallado</h5>
            <span class="badge bg-light text-dark">{{ encuestas|length }} Encuestas</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Participante</th>
                            <th>Interfaz (TIC)</th>
                            <th>Apoyo (Infra)</th>
                            <th>Barrera Principal</th>
                            <th>Políticas</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enc in encuestas %}
                        <tr>
                            <td>{{ enc.fecha|date:"d/m/Y" }}</td>
                            <td class="fw-bold">{{ enc.nombre_encuestado }}</td>
                            <td>{{ enc.get_interfaz_facilita_display }}</td>
                            <td>{{ enc.get_elementos_apoyo_display }}</td>
                            <td>{{ enc.get_barrera_frecuente_display }}</td>
                            <td>{{ enc.get_politicas_claras_display }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4">No se han registrado encuestas todavía.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-4">
        <a href="{% url 'menu_accesibilidad' %}" class="btn btn-secondary">Volver al Menú</a>
    </div>
</div>

{{ labels_interfaz|json_script:"json-labels-interfaz" }}
{{ data_interfaz|json_script:"json-data-interfaz" }}

{{ labels_apoyo|json_script:"json-labels-apoyo" }}
{{ data_apoyo|json_script:"json-data-apoyo" }}

{{ labels_barreras|json_script:"json-labels-barreras" }}
{{ data_barreras|json_script:"json-data-barreras" }}

{{ labels_politicas|json_script:"json-labels-politicas" }}
{{ data_politicas|json_script:"json-data-politicas" }}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 1. Función auxiliar para leer los datos ocultos del HTML
    function leerDatos(id) {
        return JSON.parse(document.getElementById(id).textContent);
    }

    // 2. Configuración común para dibujar gráficos
    function crearGrafico(idCanvas, labels, data, colorBase) {
        const ctx = document.getElementById(idCanvas).getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votos',
                    data: data,
                    backgroundColor: colorBase,
                    borderColor: colorBase.replace('0.6', '1'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 } 
                    }
                },
                plugins: {
                    legend: { display: false } 
                }
            }
        });
    }

    // 3. Ejecución: Leemos los datos limpios y dibujamos


    // Gráfico 1: Interfaz (Azul)
    crearGrafico('chartInterfaz', 
        leerDatos('json-labels-interfaz'), 
        leerDatos('json-data-interfaz'), 
        'rgba(54, 162, 235, 0.6)'
    );

    // Gráfico 2: Apoyo (Verde)
    crearGrafico('chartApoyo', 
        leerDatos('json-labels-apoyo'), 
        leerDatos('json-data-apoyo'), 
        'rgba(75, 192, 192, 0.6)'
    );

    // Gráfico 3: Barreras (Naranja)
    crearGrafico('chartBarreras', 
        leerDatos('json-labels-barreras'), 
        leerDatos('json-data-barreras'), 
        'rgba(255, 159, 64, 0.6)'
    );

    // Gráfico 4: Políticas (Rojo)
    crearGrafico('chartPoliticas', 
        leerDatos('json-labels-politicas'), 
        leerDatos('json-data-politicas'), 
        'rgba(255, 99, 132, 0.6)'
    );

</script>
{% endblock %}